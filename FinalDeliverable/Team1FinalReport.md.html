<meta charset="utf-8" emacsmode="-*- markdown -*-">
<!--https://casual-effects.com/markdeep/-->

**PackMat - Final Report**

An increasing trend seen in the news is package theft. It has become an increasing problem as users 
try to find ways to keep their packages secure and safe from the thieves. Many have installed cameras on 
their doors but that just is not enough. 

Introducing the PackMat! 
The newest package security system. With the PackMat, users can be assured that their packages will
be safe. To do this, the PackMat platform is made of weight sensing cells that can detect changes in 
weight to the nearest gram. Users will be able to create a username and password
that can be used to control the PackMat from our website. When there is a package delivered, the delivery
man will confirm that there is a package on the platform and therefore it will be in locked mode. In this 
secure state, if there is a change in pressure without entering the password first to unlock the PackMat, 
the alarm will sound alerting the user and the surrounding environment of the theft. The PackMat has 
functionality so that the alarm can be turned off with the keypad on site. From the website, users 
will be able to see the password they have set and when the alarm on the PackMat has gone off. Users 
will also be able to turn off the alarm remotely from the website.

![Full System PackMat Demo](https://youtu.be/4RxPeEKQD0g)

Functionality
===============================================================================
The PackMat begins in a login and passcode setting state. This set up only happens once and then after
enters the main loop of the state machine diagram. The other main modes for the PackMat are Rest, Locked, Alarm, 
and Unlocked. The full state machine diagram and system block diagram is detailed below.

![State Machine Diagram for PackMat](./State_Machine_6.08_Project.jpg)

Login Mode
-------------------------------------------------------------------------------
Once the system is started for the first time, users will be able to create a username and password through
the PackMat using the keypad. The username and password they enter here will allow users to log into their account on our
website so that they can monitor and change the status of their PackMat.

Program Mode
-------------------------------------------------------------------------------
After completing the initial login, users will be prompted to create a password (using only numbers) that will be 
utilized in unlocking and turning off the alarm in case of a security breach or package theft. This password must be set
on the physical PackMat and can only be set once. This is an added on security measure.

IDLE Mode
-------------------------------------------------------------------------------
After completing the login and progrmaming of password, the PackMat will reamin in IDLE until receiving a package.
The PackMat is looking for an increase in pressure in order to trigger it to lock. Once a delivery man delivers a package
on to the PackMat, they are then responsible for confirming that there is a package so that the PackMat will be locked. 
If there is just an increase in pressure from something other than a package (like a leaf or animal), the IDLE state
allows the PackMat to remain unlocked and not trigger any security measures if there is not a package.

Locked Mode
-------------------------------------------------------------------------------
Once our PackMat is in locked mode, you can assure that your pacakge is secure. From here, users will have the ability to 
unlock the PackMat, using the password they set in program mode, in order to retrieve their package without setting off the loud
alarm. If there is another package delivered, the delivery person would still need to confirm the additional pacakge otherwise the alarm
will sound. Similarly, if the PackMat detects a decrease in weight, an alarm will sound alerting the theif and nearby people of
the possible theif.

Security Features
-------------------------------------------------------------------------------
In order to make sure users have the most access to their PackMat, we have created a website where users can monitor
and alter the status of PackMat remotely. If the alarm is to sound and they are not on site with the PackMat, users can login
with the username and password they created when they first received the PackMat. Once logged in, users will be able to enter their
4 digit passcode in order to disarm the alarm remotely. Users will also be able to see the dates and times of when the alarm has gone off
as well as the status of the PackMat (like whether it is locked, meaning users have a package).

LCD interface
-------------------------------------------------------------------------------
Users will be able to tell what state their PackMat is in with the PackMat's LCD. Here, instructions will be displayed
on how to set their username, password, and four digit passcode as well as instructions for turning off the alarm or unlocking
the PackMat. In order to help users understand what state the PackMat is in, in addition to text instructions,
we have also color coded the states. Red for alarm/security breach, green for unlock mode, and blue for locked. 



Documentation
===============================================================================

Full System Diagram
-------------------------------------------------------------------------------
![State Machine Diagram for PackMat](./State_Machine_6.08_Project.jpg)
![System Block Diagram for PackMat](./System_Block_Diagram_6.08.jpg)

Hardware Layout
-------------------------------------------------------------------------------
### Hardware Diagram



Parts Lists 
-------------------------------------------------------------------------------
[3x4 Numberpad](https://www.adafruit.com/product/419?gclid=CjwKCAjwi6WSBhA-EiwA6Niok7_ik9O5mUpQZAu8cVJi6zW27UNA665ET1Sop1D6nTW__4h9YBZazhoC5d8QAvD_BwE)

* Total price: $3.95
* Use case: Used as a keypad to enter passcodes, usernames and passwords

[Load Cell Amplifier](https://www.sparkfun.com/products/13879?_ga=2.228677528.507380733.1648994760-989291874.1648994760)

* Total price: $10.95
* Use case: Used to connect load cells to ESP32

[Load Cell](https://www.amazon.com/Weighing-Resistance-Half-Bridge-Amplifier-Arduino/dp/B097T3SX6W/ref=asc_df_B097T3SX6W/?tag=hyprod-20&linkCode=df0&hvadid=533302859187&hvpos=&hvnetw=g&hvrand=3421353624175012600&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=1018145&hvtargid=pla-1391941843433&psc=1)

* Total price: $11.99
* Use case: Used to sense weight


Design Challenges and Decisions
-------------------------------------------------------------------------------
Some challenges in this project included:
* problem 1
* problem 2
* etc.



Detailed Code Layout
===============================================================================

ESP32 Side
-------------------------------------------------------------------------------
**********************************************************
*            Server-side                                 *
*  .------------------------------.                      *
* |     /                          |                     *
* |     |                          |                     *
* |     +--src/                    |                     *
* |     |  |                       |                     *
* |     |  +-- HX711_ADC-master/   |                     *
* |     |                          |                     *
* |     +-- src.ino                |                     *
* |     |                          |                     *
* |     +-- input_helpers.ino      |                     *
* |     +-- lcd_helpers.ino        |                     *
* |     +-- request_helpers.ino    |                     *
* |     |                          |                     *
* |     +-- packmat_fsm.ino        |                     *
*  '------------------------------'                      *
**********************************************************

### HX711_ADC-master/

The scripts in this folder were initially used to test out interfacing with the phototransistors and and the lasers in order to play notes. They are the only code here not run on the ESP32 for the final project.

### src.ino

In this file, all necessary global variables, such as timers, network and request parameters, and input pins for the buzzer and keypad are initialized. Moreover, all necessary setup, such as connecting to the WiFi 
and setting up the keypad and buzzer are done in the setup method(). The loop function is in this file as well, so within each loop, we have code to sense the weight and the loop function calls the packmat function
which contains the state machine. Finally, there is also the playTone() helper function that is used to play the alarm sound on the buzzer.

### packmat_fsm.ino

This file contains the full state machine. The state machine uses the various helper functions, inputs that represent the state of the function as passed in from the loop function, and the curr_weight as caculated in the loop function . 
These values and functions are used to maintain state and perform actions depending on the state we are in

### input_helpers.ino

This file contains two helper functions : userKeyCheck() and passwordKeyCheck(). These helper functions use the state of the keypad to update the user and password variables initiated in src.ino. Hence,
this file contains the helper functions used to update variables based on input, and they are utilized in the packmat_fsm.ino file.

### lcd_helpers.ino

This file contains helper functions that update the LCD screen according to state. This is called in the packmat_fsm.ino file in every state.

### request_helpers.ino

This file has all the helper functions related to sending post and get requests. The main helper function is the do_http_request() function as seen from labs throughout the semester, and this
function uses a separate char_append helper function as well. Next, there are four helper functions that we use directly in packmat_fsm.ino : login(), create_account(), postUpdate(), and checkWebsiteAlarmStatus()
login() and create_account() use the do_http_request helper function to send appropriate post requests to the login and create_account webpages on the server-side. Similarly, we also have checkWebsiteAlarmStatus() and postUpdate().
checkWebsiteAlarmStatus() sends a get request to the main webpage to extract the current alarm status on the server; this is used to allow us to check if the alarm is turned off remotely. Similarly, postUpdate
sends a properly-formatted POST request to the main webpage to update the webpage of a change in alarm status or the system status.

Server Side
-------------------------------------------------------------------------------


Milestone Contributions
===============================================================================
Below are our weekly milestones over the course of 4 weeks. Our team worked in parallel for the majority of the project
so for each week, there is progress made to the server side and ESP32 as well as integration.

## Week 1 - Initial Set Up

![Setting Up State Machine Diagram](https://youtu.be/5OUq7IDQ-Sc)
![Initial Keypad and Alarm Setup](https://youtu.be/vduf-a2p0uY)

## Week 2 - Beginning of Integration

![Integration of State Machine and Weight Scales](https://youtu.be/NnsDaAKGHfo)
![Remote Alarm Turn-off](https://youtu.be/pOyDTX0LhKg)

## Week 3 - Integration

![Integration of State Machine, Password, and KeyPad Functionality](https://youtu.be/HXk8rkQCjYw)
![Integration of State Machine, Password, and KeyPad Functionality pt. 2](https://www.youtube.com/watch?v=o5FIsFhgYjk)

## Week 4 - Multiple Users and Final Touches

![Final Product LCD Screens](https://youtu.be/jQnT2fozVUk)
![Keypad Coding of Username and Password](https://www.youtube.com/watch?v=ajVQP-ITg08)


Team Members 
===============================================================================
* Madison Wong
* Claire Bao
* Ye Cheng Zheng
* Michael Iglesias


<!-- Markdeep: --><style class="fallback">body{visibility:hidden;white-space:pre;font-family:monospace}</style><script src="markdeep.min.js" charset="utf-8"></script><script src="https://casual-effects.com/markdeep/latest/markdeep.min.js?" charset="utf-8"></script><script>window.alreadyProcessedMarkdeep||(document.body.style.visibility="visible")</script>
